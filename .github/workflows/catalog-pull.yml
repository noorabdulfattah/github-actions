name: Catalog Pull and Commit (Test, Multi-branch)

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: "Target branch to sync (test)"
        required: true
        default: "main"
        type: choice
        options:
          - main
          - catalog-sandbox
          - catalog-sources
          - catalog-config

  push:
    branches:
      - main
      - catalog-sandbox
      - catalog-sources
      - catalog-config

  schedule:
    - cron: "0 2 * * *"  # optional: daily at 02:00 UTC

jobs:
  pull-and-commit:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        branch: [main, catalog-sandbox, catalog-sources, catalog-config]

    # Only run the matrix item that matches the triggering branch / input
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && matrix.branch == github.event.inputs.target_branch) ||
      (github.event_name == 'push' && matrix.branch == github.ref_name)

    steps:
      - name: Resolve TARGET_BRANCH
        run: |
          echo "TARGET_BRANCH=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target_branch || (github.event_name == 'push' && github.ref_name || matrix.branch) }}" >> "$GITHUB_ENV"

      - name: Map env vars (DW_OWNER, DW_AUTH_TOKEN, API_BASE, ENVIRONMENT)
        shell: bash
        run: |
          echo "Using TARGET_BRANCH=$TARGET_BRANCH"

          # DW_OWNER: same as branch name
          echo "DW_OWNER=$TARGET_BRANCH" >> "$GITHUB_ENV"

          # API_BASE: from repo variables (set this in Settings â†’ Variables)
          echo "API_BASE=${{ vars.API_BASE }}" >> "$GITHUB_ENV"

          # ENVIRONMENT: here we just mirror the branch (adjust if you prefer dev/stage/prod mapping)
          echo "ENVIRONMENT=$TARGET_BRANCH" >> "$GITHUB_ENV"

          # Map tokens based on branch (dummy / test secrets in this repo)
          case "$TARGET_BRANCH" in
            main)
              echo "DW_AUTH_TOKEN=${{ secrets.DW_TOKEN_MAIN }}" >> "$GITHUB_ENV"
              ;;
            catalog-sandbox)
              echo "DW_AUTH_TOKEN=${{ secrets.DW_TOKEN_CATALOG_SANDBOX }}" >> "$GITHUB_ENV"
              ;;
            catalog-sources)
              echo "DW_AUTH_TOKEN=${{ secrets.DW_TOKEN_CATALOG_SOURCES }}" >> "$GITHUB_ENV"
              ;;
            catalog-config)
              echo "DW_AUTH_TOKEN=${{ secrets.DW_TOKEN_CATALOG_CONFIG }}" >> "$GITHUB_ENV"
              ;;
            *)
              echo "Unknown branch '$TARGET_BRANCH' â€“ aborting." >&2
              exit 1
              ;;
          esac

      - name: Checkout TARGET_BRANCH
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Python (optional for test, kept for parity)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (optional)
        run: |
          if [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          fi

      # ðŸ”§ TEST STEP: simulate "pull from data.world" by creating a file
      # In the real repo you will replace this whole step with your actual pull command.
      - name: Simulate pull (create test file per branch)
        env:
          DW_OWNER: ${{ env.DW_OWNER }}
          DW_AUTH_TOKEN: ${{ env.DW_AUTH_TOKEN }}
          API_BASE: ${{ env.API_BASE }}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
        run: |
          mkdir -p .github/test-output

          TS=$(date -u +'%Y%m%d-%H%M%S')
          FILE=".github/test-output/simulated_pull_${TARGET_BRANCH}_${TS}.txt"

          echo "Simulated pull for branch: $TARGET_BRANCH" > "$FILE"
          echo "DW_OWNER=$DW_OWNER" >> "$FILE"
          echo "ENVIRONMENT=$ENVIRONMENT" >> "$FILE"
          echo "API_BASE=$API_BASE" >> "$FILE"
          echo "Generated at (UTC): $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> "$FILE"

          echo "Created test file: $FILE"
          cat "$FILE"

      - name: Detect changes
        id: changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          ID=$(date -u +'%Y%m%d-%H%M%S')
          MSG="TEST: simulated DW pull ($TARGET_BRANCH) - ID:$ID"

          echo "Committing changes with message: $MSG"
          git add -A
          git commit -m "$MSG"
          git push origin "$TARGET_BRANCH"

      - name: No changes
        if: steps.changes.outputs.has_changes != 'true'
        run: echo "No changes to commit for $TARGET_BRANCH."