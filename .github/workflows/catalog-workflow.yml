name: Catalog Pull and Commit (Multi-branch)

on:
  workflow_dispatch: {}

  push:
    branches:
      - main

  schedule:
    - cron: "0 2 * * *"

# Global API_BASE for all jobs
env:
  API_BASE: "https://api.data.world/v0"   # adjust to your real base

jobs:
  pull-and-commit:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        catalog_branch:
          - catalog-main
          - catalog-sandbox
          - catalog-sources
          - ontology

    steps:
      - name: Checkout catalog branch
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.catalog_branch }}
          fetch-depth: 0

      - name: Set up Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set per-branch env vars (DW_AUTH_TOKEN, DW_OWNER, CATALOG_BRANCH)
        run: |
          echo "Setting env variables for branch: ${{ matrix.catalog_branch }}"

          case "${{ matrix.catalog_branch }}" in
            catalog-main)
              echo "DW_AUTH_TOKEN=${{ secrets.CATALOG_MAIN_TOKEN }}" >> "$GITHUB_ENV"
              echo "DW_OWNER=main" >> "$GITHUB_ENV"
              ;;
            catalog-sandbox)
              echo "DW_AUTH_TOKEN=${{ secrets.CATALOG_SANDBOX_TOKEN }}" >> "$GITHUB_ENV"
              echo "DW_OWNER=catalog-sandbox" >> "$GITHUB_ENV"
              ;;
            catalog-sources)
              echo "DW_AUTH_TOKEN=${{ secrets.CATALOG_SOURCES_TOKEN }}" >> "$GITHUB_ENV"
              echo "DW_OWNER=catalog-sources" >> "$GITHUB_ENV"
              ;;
            ontology)
              echo "DW_AUTH_TOKEN=${{ secrets.CATALOG_ONTOLOGY_TOKEN }}" >> "$GITHUB_ENV"
              echo "DW_OWNER=ontology" >> "$GITHUB_ENV"
              ;;
            *)
              echo "Unknown catalog branch: ${{ matrix.catalog_branch }}" >&2
              exit 1
              ;;
          esac

          echo "CATALOG_BRANCH=${{ matrix.catalog_branch }}" >> "$GITHUB_ENV"

      - name: Merge main into catalog branch
        run: |
          echo "Merging main into ${{ matrix.catalog_branch }}..."
          git fetch origin main
          git merge --no-edit origin/main || {
            echo "Merge conflict while merging main into ${{ matrix.catalog_branch }}."
            exit 1
          }

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Make scripts executable
        run: |
          chmod +x ./scripts/pull-promote.sh || true

      - name: Run pull-promote.sh
        env:
          API_BASE: ${{ env.API_BASE }}
          DW_AUTH_TOKEN: ${{ env.DW_AUTH_TOKEN }}
          DW_OWNER: ${{ env.DW_OWNER }}
        run: |
          ./scripts/pull-promote.sh

      - name: Check for changes
        id: git_status
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push changes
        if: steps.git_status.outputs.changes == 'true'
        run: |
          ID=$(date -u +'%Y%m%d-%H%M%S')
          COMMIT_MSG="Catalog sync test commit (${{ matrix.catalog_branch }}) - ID:$ID"
          echo "Committing changes: $COMMIT_MSG"
          git add .
          git commit -m "$COMMIT_MSG"
          git push origin ${{ matrix.catalog_branch }}

      - name: No changes detected
        if: steps.git_status.outputs.changes == 'false'
        run: echo "No changes detected for ${{ matrix.catalog_branch }}."