name: Push on merge into catalog-main

# Global env
env:
  API_BASE: "https://api.data.world/v0"
  PIP_INDEX_URL: "https://pypi.org/simple"

on:
  pull_request:
    branches:
      - catalog-main
    types:
      - opened
      - synchronize
      - reopened
      - closed

  push:
    branches:
      - catalog-main

  workflow_dispatch:

jobs:
  push-after-merge:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      DW_OWNER: main
      DW_AUTH_TOKEN: ${{ secrets.CATALOG_MAIN_TOKEN }}

    steps:
      - name: Show push info
        run: |
          echo "Ref: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "DW_OWNER: $DW_OWNER"
          echo "API_BASE: $API_BASE"

      - name: Checkout catalog-main
        uses: actions/checkout@v4
        with:
          ref: catalog-main
          fetch-depth: 0

      - name: Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
        # merge latest main into catalog-main before proceeding
      - name: Merge main into catalog-main
        run: |
              echo "Merging main into catalog-main..."
              git fetch origin main
              git merge --no-edit origin/main || {
                echo "Merge conflict while merging main into catalog-main."
                exit 1
              }

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Make scripts executable
        run: |
          chmod +x ./scripts/push.sh || true

      - name: Run push.sh
        env:
          API_BASE: ${{ env.API_BASE }}
          DW_AUTH_TOKEN: ${{ env.DW_AUTH_TOKEN }}
          DW_OWNER: ${{ env.DW_OWNER }}
        run: |
          ./scripts/push.sh

      - name: Check for changes
        id: git_status
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push changes to catalog-main
        if: steps.git_status.outputs.changes == 'true'
        run: |
          ID=$(date -u +'%Y%m%d-%H%M%S')
          COMMIT_MSG="Auto push after changes on catalog-main - ID:$ID"
          echo "Committing changes: $COMMIT_MSG"
          git add .
          git commit -m "$COMMIT_MSG"
          git push origin catalog-main

      - name: No changes to commit
        if: steps.git_status.outputs.changes == 'false'
        run: echo "No local changes after push.sh; nothing to commit."