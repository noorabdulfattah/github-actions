name: Push on Approval to catalog-main

on:
  pull_request_review:
    types: [submitted]

jobs:
  push-after-approval:
    runs-on: ubuntu-latest

    # Only run when:
    # - the review state is "approved"
    # - the PR base branch is "catalog-main"
    if: >
      github.event.review.state == 'approved' &&
      github.event.pull_request.base.ref == 'catalog-main'

    permissions:
      contents: write    # needed to push commits

    steps:
      - name: Show PR and review info
        run: |
          echo "PR #${{ github.event.pull_request.number }}"
          echo "Base branch: ${{ github.event.pull_request.base.ref }}"
          echo "Review state: ${{ github.event.review.state }}"

      - name: Checkout catalog-main
        uses: actions/checkout@v4
        with:
          ref: catalog-main
          fetch-depth: 0

      - name: Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # ------------------------------------------------------------------
      # Replace this block with your real "push" command / script.
      # This is where you call your data.world push, or any sync logic.
      # ------------------------------------------------------------------
      - name: Run push command
        run: |
          echo "Running push command after approval to catalog-main..."
          # TODO: replace this with your actual push logic, e.g.:
          # ./push.command
          # or:
          # python -m src.catalog_synchronizer.cli push --env prod
          mkdir -p tests/push-output
          echo "Push executed at $(date -u +'%Y-%m-%dT%H:%M:%SZ')" > tests/push-output/push_run_$(date -u +'%Y%m%d-%H%M%S').txt

      - name: Check for changes
        id: git_status
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes to catalog-main
        if: steps.git_status.outputs.changes == 'true'
        run: |
          ID=$(date -u +'%Y%m%d-%H%M%S')
          COMMIT_MSG="Auto push after PR approval to catalog-main - ID:$ID"
          echo "Committing changes: $COMMIT_MSG"
          git add .
          git commit -m "$COMMIT_MSG"
          git push origin catalog-main

      - name: No changes to commit
        if: steps.git_status.outputs.changes == 'false'
        run: echo "No local changes after push command; nothing to commit."